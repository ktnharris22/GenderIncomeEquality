---
title: "What Riri got Right: Gender & Pay Inequity"
author: "Jaih Hunter-Hill & Katie Harris"
date: 'December 14, 2020'
output: html_document
---

#### Package loading

```{r}
library(tidyverse)
library(knitr)
```


#### Importing the data

```{r}
# Import starting data
nlsy <- read_csv("http://www.andrew.cmu.edu/user/achoulde/94842/final_project/nlsy97/nlsy97_Nov2020.csv")

encoded.names <- names(nlsy)
```

#### Variables present in the base data set

To learn more about the data, you can have a look at the [variable codebook file](http://www.andrew.cmu.edu/user/achoulde/94842/final_project/nlsy97/nlsy97_codebook.txt).


Here's how to rename all the variables to the Question Name abbreviation.  **You will want to change the names to be even more descriptive**, but this is a start.

```{r}
# Change column names to question name abbreviations (you will want to change these further)
colnames(nlsy) <- c("PSTRAN_GPA.01_PSTR",
    "INCARC_TOTNUM_XRND",
    "INCARC_AGE_FIRST_XRND",
    "INCARC_LENGTH_LONGEST_XRND",
    "PUBID_1997",
    "YSCH-36400_1997",
    "YSCH-37000_1997",
    "YSAQ-010_1997",
    "YSAQ-369_1997",
    "YEXP-300_1997",
    "YEXP-1500_1997",
    "YEXP-1600_1997",
    "YEXP-1800_1997",
    "YEXP-2000_1997",
    "sex",
    "KEY_BDATE_M_1997",
    "KEY_BDATE_Y_1997",
    "PC8-090_1997",
    "PC8-092_1997",
    "PC9-002_1997",
    "PC12-024_1997",
    "PC12-028_1997",
    "CV_AGE_12/31/96_1997",
    "CV_BIO_MOM_AGE_CHILD1_1997",
    "CV_BIO_MOM_AGE_YOUTH_1997",
    "CV_CITIZENSHIP_1997",
    "CV_ENROLLSTAT_1997",
    "CV_HH_NET_WORTH_P_1997",
    "CV_YTH_REL_HH_CURRENT_1997",
    "CV_MSA_AGE_12_1997",
    "CV_URBAN-RURAL_AGE_12_1997",
    "CV_SAMPLE_TYPE_1997",
    "CV_HGC_BIO_DAD_1997",
    "CV_HGC_BIO_MOM_1997",
    "CV_HGC_RES_DAD_1997",
    "CV_HGC_RES_MOM_1997",
    "race",
    "YSCH-6800_1998",
    "YSCH-7300_1998",
    "YSAQ-372B_1998",
    "YSAQ-371_2000",
    "YSAQ-282J_2002",
    "YSAQ-282Q_2002",
    "CV_HH_NET_WORTH_Y_2003",
    "CV_BA_CREDITS.01_2004",
    "YSAQ-000B_2004",
    "YSAQ-373_2004",
    "YSAQ-369_2005",
    "CV_BIO_CHILD_HH_2007",
    "YTEL-52~000001_2007",
    "YTEL-52~000002_2007",
    "YTEL-52~000003_2007",
    "YTEL-52~000004_2007",
    "CV_BIO_CHILD_HH_2009",
    "CV_COLLEGE_TYPE.01_2011",
    "CV_INCOME_FAMILY_2011",
    "CV_HH_SIZE_2011",
    "CV_HH_UNDER_18_2011",
    "CV_HH_UNDER_6_2011",
    "CV_HIGHEST_DEGREE_1112_2011",
    "CV_BIO_CHILD_HH_2011",
    "YSCH-3112_2011",
    "YSAQ-000A000001_2011",
    "YSAQ-000A000002_2011",
    "YSAQ-000B_2011",
    "YSAQ-360C_2011",
    "YSAQ-364D_2011",
    "YSAQ-371_2011",
    "YSAQ-372CC_2011",
    "YSAQ-373_2011",
    "YSAQ-374_2011",
    "YEMP_INDCODE-2002.01_2011",
    "CV_BIO_CHILD_HH_2015",
    "YEMP_INDCODE-2002.01_2017",
    "YEMP_OCCODE-2002.01_2017",
    "CV_MARSTAT_COLLAPSED_2017",
    "YINC-1400_2017",
    "income",
    "YINC-1800_2017",
    "YINC-2400_2017",
    "YINC-2600_2017",
    "YINC-2700_2017",
    "CVC_YTH_REL_HH_AGE6_YCHR_XRND",
    "CVC_SAT_MATH_SCORE_2007_XRND",
    "CVC_SAT_VERBAL_SCORE_2007_XRND",
    "CVC_ACT_SCORE_2007_XRND",
    "CVC_HH_NET_WORTH_20_XRND",
    "CVC_HH_NET_WORTH_25_XRND",
    "CVC_ASSETS_FINANCIAL_25_XRND",
    "CVC_ASSETS_DEBTS_20_XRND",
    "CVC_HH_NET_WORTH_30_XRND",
    "CVC_HOUSE_VALUE_30_XRND",
    "CVC_HOUSE_TYPE_30_XRND",
    "CVC_ASSETS_FINANCIAL_30_XRND",
    "CVC_ASSETS_DEBTS_30_XRND")

### Set all negative values to NA.  
### THIS IS DONE ONLY FOR ILLUSTRATIVE PURPOSES
### DO NOT TAKE THIS APPROACH WITHOUT CAREFUL JUSTIFICATION
#nlsy[nlsy < 0]  <- NA
# use mutate if/else


#Create a data dictionary that helps with sorting and finding information on data columns
# encoded.val <- code.dict[legible.names == "Legiblename",2]
legible.names <- names(nlsy)
code.dict <- data.frame(legible.names,encoded.names)
```

#### Data Clean & Recoding
```{r}
nlsy <- as_tibble(nlsy) %>%
  rename(cocaine_use = 'YSAQ-372CC_2011',
         smokes = 'YSAQ-360C_2011',
         drinks = 'YSAQ-364D_2011') %>%
  mutate(marital_status = recode_factor(CV_MARSTAT_COLLAPSED_2017, `0`="NEVER-MARRIED", `1` = "MARRIED", `2` = "SEPARATED", `3` = "DIVORCED", `4` = "WIDOWED", `-5` = "UNKNOWN", `-3` = "UNKNOWN")) %>%
  mutate(sex = recode_factor(sex, `1`="MALE", `2`="FEMALE")) %>%
  mutate(race = recode_factor(race, `1` = "BLACK", `2` = "HISPANIC", `3` = "MIXED-RACE (NON-HISP.)", `4` = "NON-BLACK/NON-HISPANIC")) %>%
  mutate_at(c("cocaine_use", "smokes", "drinks"), ~ recode_factor(.x, `0` = "NO", `1` = "YES", .default = "UNKNOWN"))

table(nlsy$sex)
table(nlsy$race)
table(nlsy$marital_status)
table(nlsy$cocaine_use)
table(nlsy$smokes)
table(nlsy$drinks)

```
#### Data Exploration
Plotting 19 groups of 5 plots to visualize data per the following methods:
- Histogram
- scatter
- Lin-Regression

```{r}
#
plotHist <- function(data, xVec, yVec){
  data %>%
    ggplot(aes(x=xVec, y=yVec), fill = sex) +
    geom_histogram() 
}

#Plot bar chart with error bars
plotBar <- function(data, xVec, yVec){
  data %>%
    ggplot(aes(x=xVec, y=mean(yVec), fill = sex)) +
    geom_bar(stat = "identity")
}

plotLinReg <- function(data, xVec, yVec){
  data %>%
    ggplot(aes(x=xVec, y=yVec, fill = sex)) +
    geom_boxplot()
}

#
total.income <- nlsy$income
#
job.income <- nlsy$`YINC-1400_2017`
est.income <- nlsy$`YINC-1800_2017`
spousal.income <- nlsy$`YINC-2400_2017`
total.spousal.income <- nlsy$`YINC-2600_2017`
est.soupsal.income <-nlsy$`YINC-2700_2017`

code.dict[legible.names == "YINC-1400_2017",2]
code.dict[legible.names == "YINC-1800_2017",2]
code.dict[legible.names == "YINC-2400_2017",2]
code.dict[legible.names == "YINC-2600_2017",2]
code.dict[legible.names == "YINC-2700_2017",2]
code.dict[encoded.names == "U1852400",1]


```


```{r}
#sum(total.income < 0) # total na values

#nlsy[nlsy < 0]  <- NA

###RACE, SEX, MARITAL STATUS
income.data.gender <- nlsy %>%
  group_by(sex) %>%
 summarize(avg.income = mean(income))

gap.data.gender.race <- nlsy %>% 
  group_by(race) %>%
  summarize(income.gap = mean(income[sex == "MALE"], na.rm = TRUE) -
              mean(income[sex == "FEMALE"], na.rm = TRUE))

gap.data.marital_stat <- nlsy %>%
  group_by(marital_status) %>%
 summarize(income.gap = mean(income[sex == "MALE"], na.rm = TRUE) -
              mean(income[sex == "FEMALE"], na.rm = TRUE))

### ALCOHOL, TOBACCO, HARD DRUGS(Cocaine)
gap.data.gender.smokes <- nlsy %>% 
  group_by(smokes) %>%
  summarize(income.gap = mean(income[sex == "MALE"], na.rm = TRUE) -
              mean(income[sex == "FEMALE"], na.rm = TRUE))

gap.data.gender.cocaine_use <- nlsy %>% 
  group_by(cocaine_use) %>%
  summarize(income.gap = mean(income[sex == "MALE"], na.rm = TRUE) -
              mean(income[sex == "FEMALE"], na.rm = TRUE))

gap.data.gender.drinks <- nlsy %>% 
  group_by(drinks) %>%
  summarize(income.gap = mean(income[sex == "MALE"], na.rm = TRUE) -
              mean(income[sex == "FEMALE"], na.rm = TRUE))



###RACE, SEX, MARITAL STATUS
ggplot(data = income.data.gender, aes(x=sex, y=avg.income, fill=I("steelblue"))) + geom_bar(stat = "identity") +
  xlab("Gender") +
  ylab("Income") +
  ggtitle("AVG Income of Men and Women") +
  guides(fill = FALSE) #obvious gap between average income between men and women

ggplot(data = gap.data.gender.race, aes(x=race, y=income.gap, fill=I("steelblue"))) + geom_bar(stat = "identity") +
  xlab("Race") +
  ylab("Income Gap($)") +
  ggtitle("Income Gap between Men and Women, by Race") +
  guides(fill = FALSE) +
    theme(axis.text.x=element_text(angle = -15, vjust = 0)) #Significant gap between races

ggplot(data = gap.data.marital_stat, aes(x=marital_status, y=income.gap, fill=I("steelblue"))) + geom_bar(stat = "identity") +
  xlab("Marital Status") +
  ylab("Income Gap($)") +
  ggtitle("Income Gap between Men and Women, by Marital Status") +
  guides(fill = FALSE) +
    theme(axis.text.x=element_text(angle = -15, vjust = 0)) #Huge gap in income between married men and women

### ALCOHOL, TOBACCO, HARD DRUGS(Cocaine)
ggplot(data = gap.data.gender.smokes, aes(x=smokes, y=income.gap, fill=I("steelblue"))) + geom_bar(stat = "identity") +
  xlab("Smokes") +
  ylab("Income Gap($)") +
  ggtitle("Income Gap between Men and Women, by Smokes") +
  guides(fill = FALSE)

ggplot(data = gap.data.gender.cocaine_use, aes(x=cocaine_use, y=income.gap, fill=I("steelblue"))) + geom_bar(stat = "identity") +
  xlab("Cocaine Use") +
  ylab("Income Gap($)") +
  ggtitle("Income Gap between Men and Women, by Cocaine Use") +
  guides(fill = FALSE)

ggplot(data = gap.data.gender.drinks, aes(x=drinks, y=income.gap, fill=I("steelblue"))) + geom_bar(stat = "identity") +
  xlab("Drinks") +
  ylab("Income Gap($)") +
  ggtitle("Income Gap between Men and Women, by Drinks") +
  guides(fill = FALSE)

```
```
U17180.00    [YEMP_INDCODE-2002.01]                         Survey Year: 2017
  PRIMARY VARIABLE

 
             YEMP, TYPE OF BUS OR INDUSTRY CODE (2002 CENSUS 4-DIGIT) 01 (ROS 
             ITEM)
 
UNIVERSE: R >= 14 has valid employer
These are 2002 Census Industry Codes
 
      43         170 TO 290: AGRICULTURE, FORESTRY AND FISHERIES
      29         370 TO 490: MINING
      32         570 TO 690: UTILITIES
     391         770: CONSTRUCTION
     493        1070 TO 3990: MANUFACTURING
     127        4070 TO 4590: WHOLESALE TRADE
     560        4670 TO 5790: RETAIL TRADE
       0        5890: ARTS, ENTERTAINMENT AND RECREATION SERVICES
     262        6070 TO 6390: TRANSPORTATION AND WAREHOUSING
     107        6470 TO 6780: INFORMATION AND COMMUNICATION
     392        6870 TO 7190: FINANCE, INSURANCE, AND REAL ESTATE
     757        7270 TO 7790: PROFESSIONAL AND RELATED SERVICES
    1355        7860 TO 8470: EDUCATIONAL, HEALTH, AND SOCIAL SERVICES
     529        8560 TO 8690: ENTERTAINMENT, ACCOMODATIONS, AND FOOD SERVICES
     237        8770 TO 9290: OTHER SERVICES
     262        9370 TO 9590: PUBLIC ADMINISTRATION
      13        9670 TO 9890: ACTIVE DUTY MILITARY
     225        9950 TO 9990: ACS SPECIAL CODES
  -------
    5814
 
Refusal(-1)            0
Don't Know(-2)         0
Invalid Skip(-3)      65
TOTAL =========>    5879   VALID SKIP(-4)     855     NON-INTERVIEW(-5)    2250
 
Min:            170        Max:           9990        Mean:              6609.4
 
Hard Minimum: [0]
Hard Maximum: [9999]
```
```{r}
nlsy$`YEMP_INDCODE-2002.01_2017` <- cut(nlsy$`YEMP_INDCODE-2002.01_2017`, breaks = c(-5,0,169,290,369,490,569,690,769,770,1069,3990,4069,4590,4669,5790,5889,5890,6069,6390,6469,6780,6869,7190,7269,7790,7859,8470,8559,8690,8769,9290,9369,9590,9669,9890,9949,9990), labels = c("UNKNOWN","NA","AGRICULTURE, FORESTRY, FISHING","NA","MINING","NA","UTILITIES","NA","CONSTRUCTION","NA","MANUFACTURING","NA", "WHOLESALE TRADE","NA","RETAIL TRADE","NA","ENTERTAINMENT","NA","TRANSPORTATION AND wHAREHOUSING","NA","INFORMATION AND COMMUNICATION", "NA", "FINANCE, INSURANCE, AND REAL ESTATE","NA","PROFESSIONAL AND RELATED SERVICES", "NA", "EDUCATIONAL, HEALTH, AND SOCIAL SERVICES","NA","ENTERTAINMENT, ACCOMODATIONS, AND FOOD SERVICES", "NA","OTHER SERVICES","NA","PUBLIC ADMINISTRATION","NA","ACTIVE DUTY MILITARY","NA","ACS SPECIAL CODES"),include.lowest = TRUE)
#table(nlsy$`YEMP_INDCODE-2002.01_2017`)

gap.data.gender.industry <- nlsy %>% 
  group_by(`YEMP_INDCODE-2002.01_2017`) %>%
  summarize(income.gap = mean(income[sex == "MALE"], na.rm = TRUE) -
              mean(income[sex == "FEMALE"], na.rm = TRUE))

ggplot(data = gap.data.gender.industry, aes(x=`YEMP_INDCODE-2002.01_2017`, y=income.gap, fill=I("steelblue"))) + geom_bar(stat = "identity") +
  xlab("Industry") +
  ylab("Income Gap($)") +
  ggtitle("Income Gap between Men and Women, by Industry") +
  guides(fill = FALSE) +
  theme(axis.text.x=element_text(angle = -40, vjust = 0))
```
```
R12002.00    [CV_BIO_MOM_AGE_YOUTH]                         Survey Year: 1997
  PRIMARY VARIABLE

 
             AGE OF BIO MOTHER WHEN R BORN
 
Age of biological mother when respondent born.
/* EXTREME RESPONSES REFLECT UNEDITED INTERVIEW DATA THAT WERE REPORTED DURING 
THE SURVEY; RESEARCHERS MAY WANT TO EVALUATE THESE DATA BEFORE DRAWING 
CONCLUSIONS. */
 
       0           0
       0           1 TO 4
       0           5 TO 8
      34           9 TO 14
    1089          15 TO 19
    2725          20 TO 24
    2633          25 TO 29
    1387          30 TO 34
     435          35 TO 39
      57          40 TO 44
       8          45 TO 49
       8          50 TO 99999999: 50+
  -------
    8376
 
Refusal(-1)            0
Don't Know(-2)         0
Invalid Skip(-3)     608
TOTAL =========>    8984   VALID SKIP(-4)       0     NON-INTERVIEW(-5)       0
 
Min:             10        Max:            101        Mean:                25.5
 
Hard Minimum: [0]
Hard Maximum: [118]
```
```{r}
nlsy$CV_BIO_MOM_AGE_YOUTH_1997 <- cut(nlsy$CV_BIO_MOM_AGE_YOUTH_1997, breaks = c(-Inf,0,20,30,40,50,60), labels = c("Unknown","Child/Teen","20s","30s","40s","50s+"))


gap.data.AGE_MOM_YOUTH <- nlsy %>%
  group_by(CV_BIO_MOM_AGE_YOUTH_1997) %>%
 summarize(income.gap = mean(income[sex == "MALE"], na.rm = TRUE) -
              mean(income[sex == "FEMALE"], na.rm = TRUE))

ggplot(data = gap.data.AGE_MOM_YOUTH, aes(x=CV_BIO_MOM_AGE_YOUTH_1997, y=income.gap, fill=I("steelblue"))) + geom_bar(stat = "identity") +
  xlab("Age of Mother at Birth of Child") +
  ylab("Income Gap($)") +
  ggtitle("Income Gap between Men and Women, by Age of Mother at Birth") +
  guides(fill = FALSE)

```


```{r}
table(nlsy$sex)
```


#### A note on missing values

Here's an example of what the variable description files look like

```
T76400.00    [YSAQ-372CC]                                   Survey Year: 2011
  PRIMARY VARIABLE

 
             HAS R USED COCAINE/HARD DRUGS SINCE DLI?
 
Excluding marijuana and alcohol, since the date of last interview, have you used
any drugs like cocaine, crack, heroin, or crystal meth, or any other substance 
not prescribed by a doctor, in order to get high or to achieve an altered state?
 
UNIVERSE: All except prisoners in an insecure environment
 
     215       1 YES   (Go To T76401.00)
    7023       0 NO
  -------
    7238
 
Refusal(-1)           74
Don't Know(-2)        26
TOTAL =========>    7338   VALID SKIP(-4)      85     NON-INTERVIEW(-5)    1561
 
Min:              0        Max:              1        Mean:                 .03
 
Lead In: T76397.00[Default] T76399.00[Default]  T76398.00[0:0]
Default Next Question: T76403.00
```

This description says that the numbers -1, -2, -4 and -5 all have a special meaning for this variable.  They denote different types of missingness.  You can recode all of these to `NA`, but you should also think about whether the different missigness indicators are in some way informative.  (i.e., if someone refuses to answer questions related to drug use, might this inform us about their income?) 

#### Getting to know our two main variables.

In the previous chunk of code we have appropriately renamed the variables corresponding to `sex`, `race` and `income` (as reported on the 2017 survey).  Let's have a quick look at what we're working with.

```{r}
table(nlsy$sex)

table(nlsy$race)
```

The data codebook tells us that the coding for sex is `Male = 1`, `Female = 2`.  For the race/ethnicity variable, the coding is:

```
1 Black
2 Hispanic
3 Mixed Race (Non-Hispanic)
4 Non-Black / Non-Hispanic
```

You'll want to do some data manipulations to change away from the numeric codings to more interpretable labels. 

```{r}
summary(nlsy$income)

# Histogram
qplot(nlsy$income)
```

The income distributing is right-skewed like one might expect.  However, as indicated in the question description, the income variable is *topcoded* at the 2% level.  More precisely,

```{r}
n.topcoded <- with(nlsy, sum(income == max(income, na.rm = TRUE), na.rm = TRUE))
n.topcoded
```

`r n.topcoded` of the incomes are topcoded to the maximum value of `r max(nlsy$income, na.rm = TRUE)`, which is the average value of the top `r n.topcoded` earners.    You will want to think about how  to deal with this in your analysis.